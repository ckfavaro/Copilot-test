<!-- Script del widget de Copilot Studio / Omnichannel -->
<script id="Microsoft_Omnichannel_LCWidget" src="https://oc-cdn-public-sam.azureedge.net/livechatwidget/scripts/LiveChatBootstrapper.js"
onerror="(function(el){
  el.parentNode.removeChild(el);
  var s=document.createElement('script');
  s.src='https://ocprodpublicsamgs.blob.core.windows.net/livechatwidget/scripts/LiveChatBootstrapper.js';
  s.setAttribute('id', 'Microsoft_Omnichannel_LCWidget');
  s.setAttribute('data-app-id', 'fa54e582-80d7-4c85-a876-83c1cd755a4e');
  s.setAttribute('data-lcw-version', 'prod');
  s.setAttribute('data-org-id', 'afdaec26-8d3c-ee11-94d3-002248debce1');
  s.setAttribute('data-org-url', 'https://m-afdaec26-8d3c-ee11-94d3-002248debce1.br.omnichannelengagementhub.com');
  document.body.appendChild(s);
})(this);"
data-app-id="fa54e582-80d7-4c85-a876-83c1cd755a4e"
data-lcw-version="prod"
data-org-id="afdaec26-8d3c-ee11-94d3-002248debce1"
data-org-url="https://m-afdaec26-8d3c-ee11-94d3-002248debce1.br.omnichannelengagementhub.com"
async></script>

<!-- Contexto (V1: sólo peopleId) + lógica de inactividad -->
<script>
  // ===== Config =====
  const IDLE_MS = 8 * 60 * 1000;   // 8 minutos
  let idleTimer = null;
  let chatActive = false;
  let restarting = false;

  // Contexto de V1 (sin nombre ni roles)
  function contextProvider() {
    return {
      'peopleId': { value: 35.001, isDisplayable: true }
    };
  }

  // Resetea el timer de inactividad (sólo si el chat está activo)
  function resetIdle() {
    if (!chatActive) return;
    clearTimeout(idleTimer);
    idleTimer = setTimeout(() => {
      try {
        // 1) Cerrar chat actual
        Microsoft.Omnichannel.LiveChatWidget.SDK.closeChat();

        // 2) (Opcional) Volver a iniciar una nueva charla
        //    Pequeño delay para asegurar que la clausura terminó.
        restarting = true;
        setTimeout(() => {
          Microsoft.Omnichannel.LiveChatWidget.SDK.startChat();
          restarting = false;
        }, 600);
      } catch (e) {
        console.warn('No se pudo cerrar/reiniciar el chat por inactividad:', e);
      }
    }, IDLE_MS);
  }

  // Eventos de actividad del usuario que "despiertan" el timer
  ['click','keydown','mousemove','touchstart','wheel','scroll'].forEach(evt => {
    window.addEventListener(evt, resetIdle, { passive: true });
  });

  // Eventos del SDK del widget
  window.addEventListener('lcw:ready', function () {
    // Setear el contexto y abrir la conversación
    Microsoft.Omnichannel.LiveChatWidget.SDK.setContextProvider(contextProvider);
    Microsoft.Omnichannel.LiveChatWidget.SDK.startChat();
  });

  window.addEventListener('lcw:startChat', function () {
    chatActive = true;
    resetIdle();
  });

  window.addEventListener('lcw:closeChat', function () {
    chatActive = false;
    clearTimeout(idleTimer);
    // Si se cerró manualmente y no estamos en ciclo de reinicio, no hacemos nada.
    if (!restarting) {
      // Queda a elección: no reiniciar automáticamente si el usuario cerró a propósito.
    }
  });

  window.addEventListener('lcw:error', function (err) {
    console.error('LiveChatWidget error:', err);
  });
</script>
